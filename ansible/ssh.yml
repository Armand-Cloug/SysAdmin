---
- name: Gestion des clÃ©s SSH et dÃ©sactivation de l'accÃ¨s par mot de passe SSH
  hosts: all
  become: yes
  vars_files:
    - vars.yml

  tasks:

    - name: ğŸ”‘ Ajouter les clÃ©s admin dans /root/.ssh/authorized_keys
      authorized_key:
        user: root
        key: "{{ item }}"
        state: present
      loop: "{{ admin_keys }}"

    - name: ğŸ”‘ Ajouter les clÃ©s aya pour tous les utilisateurs dÃ©finis
      authorized_key:
        user: "{{ user.name }}"
        key: "{{ key }}"
        state: present
      loop: "{{ user_list | product(aya_keys) | list }}"
      loop_control:
        set_fact:
          user: "{{ item[0] }}"
          key: "{{ item[1] }}"

    - name: ğŸš« DÃ©sactiver totalement l'accÃ¨s SSH par mot de passe
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PasswordAuthentication'
        line: 'PasswordAuthentication no'
        state: present
        backup: yes

    - name: ğŸš« EmpÃªcher root de se connecter en SSH par mot de passe (dÃ©jÃ  couvert, mais on le garde)
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PermitRootLogin'
        line: 'PermitRootLogin prohibit-password'
        state: present
        backup: yes

    - name: ğŸ” RedÃ©marrer le service SSH pour appliquer la configuration
      service:
        name: ssh
        state: restarted
