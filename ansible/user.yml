---
- name: CrÃ©er les utilisateurs avec ou sans sudo
  hosts: all
  become: yes
  vars_files:
    - vars.yml

  tasks:

    - name: ğŸ” VÃ©rifier si sudo est installÃ©
      shell: which sudo
      register: sudo_check
      ignore_errors: yes
      changed_when: false

    - name: ğŸ› ï¸ Installer sudo si nÃ©cessaire
      apt:
        name: sudo
        state: present
        update_cache: yes
      when: sudo_check.rc != 0

    - name: ğŸ“‡ Charger les utilisateurs existants
      getent:
        database: passwd
      register: users_present

    - name: ğŸ‘¤ CrÃ©er uniquement les utilisateurs absents
      user:
        name: "{{ item.name }}"
        shell: /bin/bash
        groups: "{{ item.name }}"
        append: no
        create_home: yes
        state: present
      loop: "{{ user_list }}"
      when: "item.name not in users_present.ansible_facts.getent_passwd"

    - name: ğŸ”’ Configurer sudo limitÃ© pour les utilisateurs autorisÃ©s
      copy:
        dest: "/etc/sudoers.d/{{ item.name }}"
        content: |
          Cmnd_Alias FORBIDDEN = /bin/su, /usr/bin/su, /bin/bash, /bin/sh, \
          /usr/bin/vim /etc/sudoers, /usr/bin/nano /etc/sudoers, /usr/sbin/visudo
          {{ item.name }} ALL=(ALL) NOPASSWD: ALL, !FORBIDDEN
        owner: root
        group: root
        mode: '0440'
      loop: "{{ user_list }}"
      when: item.sudo
